# AVC Alerta - Backend API

Backend API para o aplicativo AVC Alerta, constru√≠do com Node.js, Express e Firebase.

## üöÄ Tecnologias

- **Node.js** - Runtime JavaScript
- **Express** - Framework web
- **TypeScript** - Tipagem est√°tica
- **Firebase Admin SDK** - Autentica√ß√£o e banco de dados
- **Firestore** - Banco de dados NoSQL
- **JWT** - Autentica√ß√£o
- **Helmet** - Seguran√ßa
- **CORS** - Cross-Origin Resource Sharing

## üìã Pr√©-requisitos

- Node.js 18+ 
- npm ou yarn
- Conta no Firebase
- Projeto Firebase configurado

## ‚öôÔ∏è Configura√ß√£o

### 1. Instalar depend√™ncias
```bash
npm install
```

### 2. Configurar Firebase

1. Acesse o [Console do Firebase](https://console.firebase.google.com/)
2. Crie um novo projeto ou use um existente
3. V√° em "Configura√ß√µes do projeto" > "Contas de servi√ßo"
4. Clique em "Gerar nova chave privada"
5. Baixe o arquivo JSON

### 3. Configurar vari√°veis de ambiente

Copie o arquivo `.env.example` para `.env`:
```bash
cp .env.example .env
```

Edite o arquivo `.env` com suas configura√ß√µes:
```env
PORT=3000
NODE_ENV=development

# Firebase Configuration
FIREBASE_PROJECT_ID=seu-projeto-firebase
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nSUA_CHAVE_PRIVADA_AQUI\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@seu-projeto.iam.gserviceaccount.com

# JWT Secret
JWT_SECRET=seu_jwt_secret_super_seguro_aqui

# CORS Origins
CORS_ORIGINS=http://localhost:8081,exp://192.168.1.100:8081
```

### 4. Configurar Firestore

No Console do Firebase:
1. V√° em "Firestore Database"
2. Clique em "Criar banco de dados"
3. Escolha "Iniciar no modo de teste" (para desenvolvimento)
4. Selecione uma localiza√ß√£o

## üèÉ‚Äç‚ôÇÔ∏è Executar

### Desenvolvimento
```bash
npm run dev
```

### Produ√ß√£o
```bash
npm run build
npm start
```

## üìö Endpoints da API

### Autentica√ß√£o
- `POST /api/auth/register` - Registrar usu√°rio
- `POST /api/auth/login` - Login
- `POST /api/auth/logout` - Logout

### Usu√°rios
- `GET /api/users/profile` - Buscar perfil
- `PUT /api/users/profile` - Atualizar perfil
- `POST /api/users/medical-info` - Salvar info m√©dica
- `GET /api/users/medical-info` - Buscar info m√©dica
- `DELETE /api/users/account` - Deletar conta

### Dados de Sa√∫de
- `POST /api/health/save` - Salvar dados
- `GET /api/health/history/:type?` - Buscar hist√≥rico
- `DELETE /api/health/:id` - Deletar registro
- `GET /api/health/stats` - Estat√≠sticas

### Emerg√™ncia
- `POST /api/emergency/contacts` - Salvar contatos
- `GET /api/emergency/contacts` - Buscar contatos
- `POST /api/emergency/contacts/add` - Adicionar contato
- `DELETE /api/emergency/contacts/:id` - Remover contato
- `POST /api/emergency/call-log` - Registrar chamada
- `GET /api/emergency/call-logs` - Hist√≥rico de chamadas

### Health Check
- `GET /health` - Status da API

## üîí Autentica√ß√£o

A API usa Firebase Authentication. O frontend deve:

1. Autenticar com Firebase Auth
2. Obter o ID Token
3. Enviar o token no header: `Authorization: Bearer <token>`

## üìä Estrutura do Banco de Dados

### Cole√ß√µes Firestore:

#### `users`
```json
{
  "name": "string",
  "email": "string", 
  "phone": "string",
  "medicalInfo": {
    "allergies": ["string"],
    "medications": ["string"],
    "conditions": ["string"],
    "bloodType": "string",
    "height": "number",
    "weight": "number"
  },
  "createdAt": "timestamp",
  "updatedAt": "timestamp"
}
```

#### `healthData`
```json
{
  "userId": "string",
  "type": "bp|heartRate|weight",
  "data": {
    "systolic": "number", // para BP
    "diastolic": "number", // para BP
    "value": "number", // para HR e weight
    "notes": "string"
  },
  "timestamp": "timestamp",
  "createdAt": "timestamp"
}
```

#### `emergencyContacts`
```json
{
  "userId": "string",
  "contacts": [
    {
      "id": "string",
      "name": "string",
      "number": "string",
      "relation": "string",
      "type": "personal|medical"
    }
  ],
  "updatedAt": "timestamp"
}
```

## üß™ Testes

```bash
npm test
```

## üì¶ Deploy

### Heroku
1. Instale o Heroku CLI
2. Fa√ßa login: `heroku login`
3. Crie app: `heroku create avc-alerta-api`
4. Configure vari√°veis: `heroku config:set FIREBASE_PROJECT_ID=...`
5. Deploy: `git push heroku main`

### Railway
1. Conecte seu reposit√≥rio
2. Configure as vari√°veis de ambiente
3. Deploy autom√°tico

## üîß Troubleshooting

### Erro de CORS
- Verifique se o frontend est√° na lista `CORS_ORIGINS`
- Para desenvolvimento local, use: `http://localhost:8081`
- Para Expo, use: `exp://SEU_IP:8081`

### Erro de Firebase
- Verifique se as credenciais est√£o corretas
- Confirme se o projeto Firebase existe
- Verifique se o Firestore est√° habilitado

### Erro de autentica√ß√£o
- Confirme se o token est√° sendo enviado corretamente
- Verifique se o token n√£o expirou
- Confirme se o usu√°rio existe no Firebase Auth

## üìù Logs

Os logs s√£o exibidos no console durante desenvolvimento. Em produ√ß√£o, considere usar um servi√ßo como:
- **Loggly**
- **Papertrail** 
- **Winston** com transports

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch: `git checkout -b feature/nova-feature`
3. Commit: `git commit -m 'Adiciona nova feature'`
4. Push: `git push origin feature/nova-feature`
5. Abra um Pull Request